# Generalized Procrustes Analysis (GPA) Module III

This tutorial demonstrates how to use SlicerMorphR to import landmark data and the output of the GPA module of SlicerMorph into R using the accompanied SlicerMorphR R pacakge.

## Install and load SlicerMorphR
Use `devtools::install_github('SlicerMorph/SlicerMorphR')` to install the stable version

Functions in the stable version include:
* `read.markups.fcsv()` : Reads the 3D Slicer Markups file saved in fcsv format
* `read.markups.json()`:  Reads the 3D Slicer Markups file saved in json format (the default format)
* `write.markups.fcsv()`: Writes a matrix of 3D LM coordinates in 3D Slicer's Markups format as fcsv. By default LM coordinates are written with LPS (Left-Posterior-SUperior) coordinate system header, which is default in Slicer.
* `parser()` : Reads and parses the analysis.log file as output by the SlicerMorph's GPA module.  


## Exporting data for Analysis in R
You can get your morphometrics data from SlicerMorph into R in two ways using functions from SlicerMorphR:

1. You can use the original landmark coordinates as saved in FCSV or JSON format. 
2. You can use the SlicerMorphs GPA aligned coordinates directly into your allometric regression model or any other shape analysis.

Provided that you used identical settings across different GPA sofware (e.g., gpagen in geomorph), both options should (and will) give you identical results (within machine precision). Below is an exercise that demonstrates it using one of the sample datasets from SlicerMorph. 

### Directly import FCSV and JSON files into R

FCSV is a very simple file format. You can write your import function simply using the base R `read.csv()` function. For JSON, you will need a JSON parser library. THere are a number of them for R (e.g., jsonlite, rjson etc). We have developed two convinence functions `read.markups.fcsv` and `read.markups.json` that lets you import fiducial markups generated by Slicer into R, either from FCSV or JSON format. We will only demonstrate `read.markups.fcsv`. 

Use the GPA module to run GPA/PCA analysis on the Gorilla skull landmark dataset `Gorilla Skull Landmarks Only` available in the `Sample Data` module. You can refer to the instructions in [GPA I: Basics of GPA Fitting](../GPA_1/README.md) for details on using this module. The sample data should be stored in `path/to/cache/Gorilla_Skull_LMs`. You can cehck the cache path of Slicer in `Edit/Application Settings/Cache`. Make a note of the output folder you specified. You will need to enter this into the R. 

```
library(SlicerMorphR)

lm = read.markup.fcsv(file = 'path/to/cache/Gorilla_Skull_LMs/USNM174715.fcsv', forceLPS = TRUE) #Load one fcsv file

```

This will report the coordinates saved in the fcsv file as a 2D matrix. Users can write a loop for loading a series of fcsv files.
* Note that a parameter `forceLPS` used to detect whether an fcsv file is in the format of `LPS`. In the older version of 3D Slicer, markup coordinates were written in `RAS` (Right-Anterior-Superior) coordinate system assumption. More recently, it has been saved as `LPS` (Left-Posterior-Superior). 
* If forceLPS set to FALSE (default), the contents of the file will be read as it is, ignoring the header information, where the coordinate system is stored.
* If forceLPS is set to TRUE, the function will check for the coordinate system definition in the FCSV header, and will negate the x,y coordinate values if the coordinate system is defined as RAS. File will be read as is, if the coordinate system definition is LPS. In this tutorial, we set up forceLPS = TRUE to make the loaded sample landmark sets consistent with the output of the GPA module.
* For details of the forceLPS parameter, please see the helper file of `read.markups.fcsv `using `?read.markups.fcsv`.


### Reading the GPA module LOG File using parser()
Additionally, we provide another convenience function to parse the log output (**analysis.log** file) from GPA module output. Parser saves everything necessary, including the output files as well as raw coordinates, in a large R object. You can find the function here:

```
library(SlicerMorphR)
logFile = parser('path/to/analysis.log', forceLPS = True)
```
This will save `analysis.log` into `logFile` Again, this function includes a forceLPS parameter, which is set up as FALSE by default. The usage of this parameter is the same as `read.markups.fcsv()`because `parser()` uses this function to load fcsv files. If forceLPS is set up as TRUE, parser() will convert non-LPS fcsv files into fcsv format. For details, please see the helper file of `read.markups.fcsv `using `?read.markups.fcsv`.

Specifically, it provides:
  * $input.path = Unix style path to input folder with landmark files.
  * $output.path = Unix stype path to the output folder created by GPA
  * $files = files included in the analysis
  * $format = format of landmark files ("fcsv" or "mrk.json")
  * $no.LM = number of landmarks original
  * $skipped = If any landmark is omitted in GPA (TRUE/FALSE) 
  * $skippedLM = Indices of skipped LMs (created only if $skipped=TRUE)
  * $scale = are data scaled by centroid sizes (TRUE/FALSE)
  * $MeanShape = filename that contains mean shape coordinates calculated by GPA (csv format)
  * $eigenvalues = filename that contains eigenvalues as calculated by PCA in the SlicerMorph GPA (csv format)
  * $eigenvectors = filename that contains eigenvectors as calculated by PCA in the SlicerMorph GPA (csv format)
  * $OutputData = filename that contains procrustes distances, centroid sizes and procrustes aligned coordinates as calculated by the SlicerMorph GPA (csv format)
  * $pcScores = filename that contains individal PC scores of specimens as calculated by PCA in the SlicerMorph GPA (csv format)
  * $ID = list of specimen identifiers (obtained from file names)
  * $LM = 3D landmark array that contains the 3D raw coordinates as inputed to the SlicerMorph GPA module. 
  * $semi = If any landmarks are tagged as semi-landmarks (TRUE/FALSE)
  * $semiLM = indices of LMs tagged as semi-landmarks (created only if $semi==TRUE)
  
These three functions `read.markups.fcsv`, `read.markups.json`, and `parser()` provide everything you need to get SlicerMorph data into R; regardless if it is raw coordinates, or output from GPA module. 

## Example R analysis
Now, we will go through a R markdown document that will use the parser() function above to import data into R and fit an allometric regression model to both raw coordinates as well and GPA aligned procrustes coordinates. To do the next steps in tutorial, you have to complete these two steps:

1. Use the GPA module to run GPA/PCA analysis on the Gorilla skull landmark dataset available in the `Sample Data` module. You can refer to the instructions in [GPA I: Basics of GPA Fitting](../GPA_1/README.md) for details on using this module. Make a note of the output folder you specified. You will need to enter this into the R.
2. Go through [parser() and sample R analysis tutorial](./parser_and_sample_R_analysis.md) for using parser() to load GPA module output and conduct a sample regression analysis in R. 

Continue following the instructions in the tutorial. 
